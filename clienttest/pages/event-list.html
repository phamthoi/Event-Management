<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event List - Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100 min-h-screen">

<h1 class="text-2xl font-bold mb-4">Event List</h1>

<!-- Filter -->
<div class="mb-4 flex flex-wrap gap-2">
  <input type="text" id="filterName" placeholder="Event name" class="border px-3 py-1 rounded">
  <input type="text" id="filterLocation" placeholder="Location" class="border px-3 py-1 rounded">
  <select id="filterStatus" class="border px-3 py-1 rounded">
    <option value="">Status</option>
    <option value="DRAFT">DRAFT</option>
    <option value="REGISTRATION">REGISTRATION</option>
    <option value="READY">READY</option>
    <option value="ONGOING">ONGOING</option>
    <option value="COMPLETED">COMPLETED</option>
    <option value="CANCELLED">CANCELLED</option>
  </select>
  <input type="date" id="filterStart" class="border px-3 py-1 rounded">
  <input type="date" id="filterEnd" class="border px-3 py-1 rounded">
  <button id="applyFilter" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">Filter</button>
</div>

<!-- Table event -->
<table class="w-full border-collapse border border-gray-300" id="eventTable">
  <thead>
    <tr class="bg-gray-200">
      <th class="border px-3 py-2">#</th>
      <th class="border px-3 py-2">Name</th>
      <th class="border px-3 py-2">Location</th>
      <th class="border px-3 py-2">Time</th>
      <th class="border px-3 py-2">Deposit (VND)</th>
      <th class="border px-3 py-2">Status</th>
      <th class="border px-3 py-2">Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Pagination -->
<div id="pagination" class="mt-4 flex gap-2 items-center"></div>

<div id="msg" class="mt-2 text-red-500"></div>

<script>
function initEventList(){
  const API_BASE = "http://localhost:4000"; 
  const token = localStorage.getItem("token");
  const eventTable = document.getElementById("eventTable").querySelector("tbody");
  const msg = document.getElementById("msg");
  const pagination = document.getElementById("pagination");

  let currentPage = 1;
  const limit = 5; // sá»‘ dÃ²ng má»—i trang

  if (!token) {
    alert("You are not logged in");
    window.location.href = "/login.html"; 
  }

  // ðŸ”¹ Load events
  async function loadEvents(applyFilter = false, page = 1) {
    const params = new URLSearchParams();
    params.append("page", page);
    params.append("limit", limit);

    if (applyFilter) {
      const name = document.getElementById("filterName").value;
      const location = document.getElementById("filterLocation").value;
      const status = document.getElementById("filterStatus").value;
      const startDate = document.getElementById("filterStart").value;
      const endDate = document.getElementById("filterEnd").value;

      if (name) params.append("name", name);
      if (location) params.append("location", location);
      if (status) params.append("status", status);
      if (startDate) params.append("startDate", startDate);
      if (endDate) params.append("endDate", endDate);
    }

    try {
      const res = await fetch(`${API_BASE}/admin/events/list?` + params.toString(), {
        headers: { "Authorization": "Bearer " + token }
      });

      const data = await res.json();

      if (!res.ok) {
        msg.textContent = data.message || "Error loading events";
        return;
      }

      eventTable.innerHTML = "";
      if (!data.events || data.events.length === 0) {
        eventTable.innerHTML = `<tr><td colspan="7" class="text-center p-3 text-gray-500">No events</td></tr>`;
        pagination.innerHTML = "";
        return;
      }

      data.events.forEach((ev, idx) => {
        const endStr = ev.endAt ? new Date(ev.endAt).toLocaleString() : "-";
        const startStr = ev.startAt ? new Date(ev.startAt).tolocaleString() : "-";
        

        const depositStr = ev.deposit != null
          ? `${Number(ev.deposit).toLocaleString("vi-VN")}`
          : "0 VND";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-3 py-2">${(page - 1) * limit + idx + 1}</td>
          <td class="border px-3 py-2">${ev.title}</td>
          <td class="border px-3 py-2">${ev.location || "-"}</td>
          <td class="border px-3 py-2">${startStr} - ${endStr}</td>
          <td class="border px-3 py-2 text-right">${depositStr}</td> 
          <td class="border px-3 py-2">${ev.status}</td>
          <td class="border px-3 py-2">
            <a href="/pages/edit-event.html?id=${ev.id}" class="text-blue-600 hover:underline mr-2">Update</a>
            <a href="#" onclick="deleteEvent(${ev.id})" class="text-blue-600 hover:underline">Delete</a>
          </td>
        `;
        eventTable.appendChild(tr);
      });

      // ðŸ”¹ Render pagination
      currentPage = data.page;
      renderPagination(data.total, data.page, data.limit);

    } catch (err) {
      msg.textContent = "Error: " + err.message;
    }
  }

  function renderPagination(total, page, limit) {
    const totalPages = Math.ceil(total / limit);
    pagination.innerHTML = "";

    if (totalPages <= 1) return;

    // Prev
    if (page > 1) {
      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Prev";
      prevBtn.className = "px-3 py-1 border rounded bg-gray-200 hover:bg-gray-300";
      prevBtn.onclick = () => loadEvents(true, page - 1);
      pagination.appendChild(prevBtn);
    }

    // Numbers
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className =
        "px-3 py-1 border rounded " +
        (i === page ? "bg-blue-600 text-white" : "bg-gray-200 hover:bg-gray-300");
      btn.onclick = () => loadEvents(true, i);
      pagination.appendChild(btn);
    }

    // Next
    if (page < totalPages) {
      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next";
      nextBtn.className = "px-3 py-1 border rounded bg-gray-200 hover:bg-gray-300";
      nextBtn.onclick = () => loadEvents(true, page + 1);
      pagination.appendChild(nextBtn);
    }
  }

  window.deleteEvent = async function(eventId) {
    if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a event nÃ y?")) return;

    try {
      const res = await fetch(`${API_BASE}/admin/events/${eventId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();

      if (!res.ok) throw new Error(data.message || "Delete failed");

      alert("Event deleted successfully");
      loadEvents(false, currentPage); 
    } catch (err) {
      alert("Error: " + err.message);
   }
  }

  document.getElementById("applyFilter").addEventListener("click", () => loadEvents(true, 1));

  loadEvents(false, 1);
}
</script>

</body>
</html>
