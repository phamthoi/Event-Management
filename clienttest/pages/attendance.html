<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attende Member - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold mb-4">Attende Member</h1>

  <!-- Ch·ªçn event -->
  <div class="mb-4">
    <label class="block mb-2 font-medium">Choose Event:</label>
    <select id="eventSelect" class="w-full border px-3 py-2 rounded">
      <option value="">-- Choose event --</option>
    </select>
  </div>

  <!-- B·∫£ng danh s√°ch member -->
  <table class="w-full border-collapse border border-gray-300" id="memberTable">
    <thead>
      <tr class="bg-gray-200">
        <th class="border px-3 py-2">#</th>
        <th class="border px-3 py-2">Name</th>
        <th class="border px-3 py-2">Email</th>
        <th class="border px-3 py-2">Join</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="saveBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>

  <div id="msg" class="mt-2 text-red-500"></div>

<script>
/**
const API_BASE = "http://localhost:4000"; // ch·ªânh theo backend
const token = localStorage.getItem("token");
const eventSelect = document.getElementById("eventSelect");
const memberTable = document.getElementById("memberTable").querySelector("tbody");
const saveBtn = document.getElementById("saveBtn");
const msg = document.getElementById("msg");

// ‚úÖ Ki·ªÉm tra token
if (!token) {
  alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
  window.location.href = "/login.html";
}

// 1Ô∏è‚É£ Load danh s√°ch event
async function loadEvents() {
  try {
    const res = await fetch(`${API_BASE}/admin/events/list`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) {
      const errorData = await res.json();
      msg.textContent = errorData.message || "Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch event";
      return;
    }

    const data = await res.json();
    data.events.forEach(ev => {
      const option = document.createElement("option");
      option.value = ev.id;
      option.textContent = ev.title;
      option.dataset.startAt = ev.startAt;
      option.dataset.endAt = ev.endAt;
      eventSelect.appendChild(option);
    });
  } catch (err) {
    msg.textContent = "L·ªói t·∫£i event: " + err.message;
  }
}

// 2Ô∏è‚É£ Load danh s√°ch member khi ch·ªçn event
eventSelect.addEventListener("change", async () => {
  const eventId = eventSelect.value;
  if (!eventId) {
    memberTable.innerHTML = "";
    return;
  }

  const selectedOption = eventSelect.selectedOptions[0];
  const eventStart = new Date(selectedOption.dataset.startAt);
  const eventEnd = new Date(selectedOption.dataset.endAt);
  const now = new Date();

  const isOngoing = now >= eventStart && now <= eventEnd;
  console.log("üîπ Event Start:", eventStart, "End:", eventEnd, "Now:", now, "isOngoing:", isOngoing);

  try {
    const res = await fetch(`${API_BASE}/admin/events/${eventId}/registrations`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) {
      const errorData = await res.json();
      msg.textContent = errorData.message || "Kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch member";
      return;
    }

    const data = await res.json();
    memberTable.innerHTML = "";

    if (!data.registrations || data.registrations.length === 0) {
      memberTable.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-gray-500">Kh√¥ng c√≥ member n√†o</td></tr>`;
      return;
    }

    data.registrations.forEach((reg, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border px-3 py-2">${idx+1}</td>
        <td class="border px-3 py-2">${reg.user.fullName || "-"}</td>
        <td class="border px-3 py-2">${reg.user.email}</td>
        <td class="border px-3 py-2 text-center">
          <input type="checkbox" class="attendCheck" data-id="${reg.id}" 
            ${reg.attended ? "checked" : ""} ${!isOngoing ? "disabled" : ""}>
        </td>
      `;
      memberTable.appendChild(tr);
    });
  } catch (err) {
    msg.textContent = "L·ªói t·∫£i member: " + err.message;
  }
});

// 3Ô∏è‚É£ L∆∞u ƒëi·ªÉm danh
saveBtn.addEventListener("click", async () => {
  const checkboxes = document.querySelectorAll(".attendCheck");
  const updates = Array.from(checkboxes)
    .filter(cb => !cb.disabled) // ch·ªâ g·ª≠i checkbox c√≥ th·ªÉ update
    .map(cb => ({
      id: parseInt(cb.dataset.id),
      attended: cb.checked
    }));

  if (updates.length === 0) {
    msg.textContent = "Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë·ªÉ l∆∞u";
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/admin/registrations/attendance`, {
      method: "PUT",
      headers: { 
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ updates })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "L·ªói c·∫≠p nh·∫≠t ƒëi·ªÉm danh");

    msg.textContent = "‚úÖ C·∫≠p nh·∫≠t ƒëi·ªÉm danh th√†nh c√¥ng";
    msg.classList.remove("text-red-500"); 
    msg.classList.add("text-green-500");
  } catch (err) {
    msg.textContent = err.message;
    msg.classList.remove("text-green-500");
    msg.classList.add("text-red-500");
  }
});

loadEvents();
*/

function initAttendance() {
  /**
   * G·ªçi h√†m initAttendance() sau khi load page n√†y
   * ƒë·ªÉ kh·ªüi t·∫°o c√°c s·ª± ki·ªán v√† logic c·∫ßn thi·∫øt
   */
  const API_BASE = "http://localhost:4000"; // ch·ªânh theo backend
  const token = localStorage.getItem("token");
  const eventSelect = document.getElementById("eventSelect");
  const memberTable = document.getElementById("memberTable").querySelector("tbody");
  const saveBtn = document.getElementById("saveBtn");
  const msg = document.getElementById("msg");

  // ‚úÖ Ki·ªÉm tra token
  if (!token) {
    alert("You are not logged in");
    window.location.href = "/login.html";
  }

  // 1Ô∏è‚É£ Load danh s√°ch event
  async function loadEvents() {
    try {
      const res = await fetch(`${API_BASE}/admin/events/list`, {
        headers: { "Authorization": "Bearer " + token }
      });
      if (!res.ok) {
        const errorData = await res.json();
        msg.textContent = errorData.message || "No events found";
        return;
      }

      const data = await res.json();
      data.events.forEach(ev => {
        const option = document.createElement("option");
        option.value = ev.id;
        option.textContent = ev.title;
        option.dataset.startAt = ev.startAt;
        option.dataset.endAt = ev.endAt;
        eventSelect.appendChild(option);
      });
    } catch (err) {
      msg.textContent = "Error loading event: " + err.message;
    }
  }

  // 2Ô∏è‚É£ Load danh s√°ch member khi ch·ªçn event
  eventSelect.addEventListener("change", async () => {
    const eventId = eventSelect.value;
    if (!eventId) {
      memberTable.innerHTML = "";
      return;
    }

    const selectedOption = eventSelect.selectedOptions[0];
    const eventStart = new Date(selectedOption.dataset.startAt);
    const eventEnd = new Date(selectedOption.dataset.endAt);
    const now = new Date();

    const isOngoing = now >= eventStart && now <= eventEnd;
    console.log("üîπ Event Start:", eventStart, "End:", eventEnd, "Now:", now, "isOngoing:", isOngoing);

    try {
      const res = await fetch(`${API_BASE}/admin/events/${eventId}/registrations`, {
        headers: { "Authorization": "Bearer " + token }
      });
      if (!res.ok) {
        const errorData = await res.json();
        msg.textContent = errorData.message || "Cannot load member list";
        return;
      }

      const data = await res.json();
      memberTable.innerHTML = "";

      if (!data.registrations || data.registrations.length === 0) {
        memberTable.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-gray-500">Kh√¥ng c√≥ member n√†o</td></tr>`;
        return;
      }

      data.registrations.forEach((reg, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-3 py-2">${idx+1}</td>
          <td class="border px-3 py-2">${reg.user.fullName || "-"}</td>
          <td class="border px-3 py-2">${reg.user.email}</td>
          <td class="border px-3 py-2 text-center">
            <input type="checkbox" class="attendCheck" data-id="${reg.id}" 
              ${reg.attended ? "checked" : ""} ${!isOngoing ? "disabled" : ""}>
          </td>
        `;
        memberTable.appendChild(tr);
      });
    } catch (err) {
      msg.textContent = "Error loading member: " + err.message;
    }
  });

  // 3Ô∏è‚É£ L∆∞u ƒëi·ªÉm danh
  saveBtn.addEventListener("click", async () => {
    const checkboxes = document.querySelectorAll(".attendCheck");
    const updates = Array.from(checkboxes)
      .filter(cb => !cb.disabled) // ch·ªâ g·ª≠i checkbox c√≥ th·ªÉ update
      .map(cb => ({
        id: parseInt(cb.dataset.id),
        attended: cb.checked
      }));

    if (updates.length === 0) {
      msg.textContent = "Noe changes to save";
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/admin/registrations/attendance`, {
        method: "PUT",
        headers: { 
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ updates })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "L·ªói c·∫≠p nh·∫≠t ƒëi·ªÉm danh");

      msg.textContent = "‚úÖ update attendance successful";
      msg.classList.remove("text-red-500"); 
      msg.classList.add("text-green-500");
    } catch (err) {
      msg.textContent = err.message;
      msg.classList.remove("text-green-500");
      msg.classList.add("text-red-500");
    }
  });

  loadEvents();
}
</script>
</body>
</html>
