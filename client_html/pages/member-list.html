<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Danh s√°ch Member - Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100 min-h-screen">

<h1 class="text-2xl font-bold mb-4">Danh s√°ch Member</h1>

<!-- Filter -->
<div class="mb-4 flex flex-wrap gap-2">
  <input type="text" id="filterEmail" placeholder="Email" class="border px-3 py-1 rounded">
  <input type="text" id="filterFullName" placeholder="Full name" class="border px-3 py-1 rounded">
  <select id="filterActive" class="border px-3 py-1 rounded">
    <option value="">Status</option>
    <option value="true">Active</option>
    <option value="false">Locked</option>
  </select>
  <button id="applyFilter" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">L·ªçc</button>
</div>

<!-- Table member -->
<table class="w-full border-collapse border border-gray-300" id="memberTable">
  <thead>
    <tr class="bg-gray-200">
      <th class="border px-3 py-2">#</th>
      <th class="border px-3 py-2">Email</th>
      <th class="border px-3 py-2">Full Name</th>
      <th class="border px-3 py-2">Phone</th>
      <th class="border px-3 py-2">Status</th>
      <th class="border px-3 py-2">Active</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Pagination -->
<div class="flex justify-between items-center mt-4">
  <button id="prevPage" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400">Previous</button>
  <span id="pageInfo">Page 1</span>
  <button id="nextPage" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400">Next</button>
</div>

<div id="msg" class="mt-2 text-red-500"></div>

<script>
function initMemberList() {
  const API_BASE = "http://localhost:4000"; 
  const token = localStorage.getItem("token");
  const msg = document.getElementById("msg");
  const memberTable = document.getElementById("memberTable").querySelector("tbody");
  const pageInfo = document.getElementById("pageInfo");
  const prevBtn = document.getElementById("prevPage");
  const nextBtn = document.getElementById("nextPage");

  let currentPage = 1;
  const limit = 5; // s·ªë member m·ªói trang

  if (!token) {
    alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p");
    window.location.href = "/login.html";
    return;
  }

  // üîπ Load danh s√°ch member
  async function loadMembers(applyFilter = false) {
    const params = new URLSearchParams();
    params.append("page", currentPage);
    params.append("limit", limit);

    if (applyFilter) {
      const email = document.getElementById("filterEmail").value;
      const fullName = document.getElementById("filterFullName").value;
      const isActive = document.getElementById("filterActive").value;
      if (email) params.append("email", email);
      if (fullName) params.append("fullName", fullName);
      if (isActive) params.append("isActive", isActive);
    }

    try {
      const res = await fetch(`${API_BASE}/admin/members/list?` + params.toString(), {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      if (!res.ok) {
        msg.textContent = data.message || "L·ªói t·∫£i danh s√°ch member";
        return;
      }

      memberTable.innerHTML = "";
      if (!data.members || data.members.length === 0) {
        memberTable.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-gray-500">Kh√¥ng c√≥ member n√†o</td></tr>`;
      } else {
        data.members.forEach((member, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border px-3 py-2">${(currentPage - 1) * limit + idx + 1}</td>
            <td class="border px-3 py-2">${member.email}</td>
            <td class="border px-3 py-2">${member.fullName || "-"}</td>
            <td class="py-2 px-4">${member.phoneNumber || "-"}</td>
            <td class="border px-3 py-2 ${member.isActive ? "text-green-600" : "text-red-600"}">
              ${member.isActive ? "Active" : "Locked"}
            </td>
            <td class="border px-3 py-2 space-x-2">
              <button class="view-btn bg-gray-300 px-2 py-1 rounded hover:bg-gray-400">View</button>
              <button class="lock-btn bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">
                ${member.isActive ? "Lock" : "Unlock"}
              </button>
              <button class="reset-btn bg-yellow-400 px-2 py-1 rounded hover:bg-yellow-500">Reset PW</button>
            </td>
          `;
          memberTable.appendChild(tr);

          tr.querySelector(".view-btn").addEventListener("click", () => viewMember(member.id));
          tr.querySelector(".lock-btn").addEventListener("click", () => toggleLock(member.id, member.isActive));
          tr.querySelector(".reset-btn").addEventListener("click", () => resetPassword(member.id));
        });
      }

      // c·∫≠p nh·∫≠t s·ªë trang
      pageInfo.textContent = `Page ${currentPage}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = !data.hasMore; // backend tr·∫£ v·ªÅ hasMore ƒë·ªÉ bi·∫øt c√≤n trang sau kh√¥ng
    } catch (err) {
      msg.textContent = "L·ªói: " + err.message;
    }
  }

  // üîπ C√°c h√†m h√†nh ƒë·ªông
  function viewMember(id) {
    alert("Xem chi ti·∫øt member: " + id);
  }

  async function toggleLock(id, isActive) {
    try {
      const res = await fetch(`${API_BASE}/admin/members/${id}/${isActive ? "lock" : "unlock"}`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      alert(data.message);
      loadMembers();
    } catch (err) {
      alert("L·ªói: " + err.message);
    }
  }

  async function resetPassword(id) {
    if (!confirm("Reset password v·ªÅ 'Member@123'?")) return;
    try {
      const res = await fetch(`${API_BASE}/admin/members/${id}/reset-password`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      alert(data.message);
    } catch (err) {
      alert("L·ªói: " + err.message);
    }
  }

  // üîπ Pagination
  prevBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      loadMembers();
    }
  });

  nextBtn.addEventListener("click", () => {
    currentPage++;
    loadMembers();
  });

  // üîπ Filter
  document.getElementById("applyFilter").addEventListener("click", () => {
    currentPage = 1; // reset v·ªÅ trang 1
    loadMembers(true);
  });

  // üîπ G√°n global
  window.viewMember = viewMember;
  window.toggleLock = toggleLock;
  window.resetPassword = resetPassword;

  // üîπ Load l·∫ßn ƒë·∫ßu
  loadMembers(false);
}
</script>

</body>
</html>
