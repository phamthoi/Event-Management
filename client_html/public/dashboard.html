<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, sans-serif; }
    .sidebar { width: 250px; }
    .main { flex: 1; padding: 16px; }
    .dropdown-content { display: none; flex-direction: column; margin-left: 8px; }
    .dropdown:hover .dropdown-content { display: flex; }
    .sidebar button { text-align: left; width: 100%; }
  </style>
</head>
<body class="flex min-h-screen bg-gray-100">

  <!-- Sidebar -->
  <div class="sidebar bg-white p-4 shadow-lg flex flex-col gap-2">
    <h2 class="text-xl font-bold mb-4">Admin Dashboard</h2>
    
    <!-- Hi·ªÉn th·ªã t√™n admin -->
    <div id="admin-info" class="mb-4 p-2 bg-gray-100 rounded text-sm text-gray-700">
      üë§ Loading...
    </div>

    <!-- Event Dropdown -->
    <div class="dropdown">
      <button class="font-semibold">Event ‚ñæ</button>
      <div class="dropdown-content gap-1 ml-2">
        <button onclick="loadPage('/pages/createEvent.html')">Create Event</button>
        <button onclick="loadPage('/pages/event-list.html', 'initEventList')">Event List</button>
        <button onclick="loadPage('/pages/attendance.html', 'initAttendance')">Attendance</button>
      </div>
    </div>

    <!-- Member Dropdown -->
    <div class="dropdown">
      <button class="font-semibold">Member ‚ñæ</button>
      <div class="dropdown-content gap-1 ml-2">
        <button onclick="loadPage('/pages/createMember.html')">Create Member</button>
        <button onclick="loadPage('/pages/member-list.html', 'initMemberList')">Member List</button>
      </div>
    </div>

    <!-- Event Dropdown -->
    <div class="dropdown">
      <button class="font-semibold">Notifications ‚ñæ</button>
      <div class="dropdown-content gap-1 ml-2">
        <button onclick="loadPage('/pages/send-notification.html', 'initSendNotification')">Send Notification</button>
      </div>
    </div>

    <button onclick="logout()" class="mt-auto text-red-600 font-semibold">Logout</button>
  </div>

  <!-- Main content -->
  <div class="main bg-white shadow-lg rounded-lg p-4" id="main-content">
    <h3>Welcome to Admin Dashboard</h3>
    <p>Select an option from the sidebar.</p>
  </div>

<script>
const token = localStorage.getItem('token');
if (!token) {
  alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p');
  window.location.href = '/login.html';
}

// ‚úÖ Verify token
async function verifyToken() {
  try {
    const res = await fetch('http://localhost:4000/admin/dashboard', {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error("Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n");

    const data = await res.json();

    const infoBox = document.getElementById("admin-info");
    infoBox.textContent = `üë§ ${data.user.fullName || data.user.email} (${data.user.role})`;

    // Load default page: Event List
    loadPage('/pages/event-list.html');
  } catch(err) {
    alert(err.message);
    localStorage.removeItem('token');
    window.location.href = '/login.html';
  }
}

async function loadPage(filePath) {
  try {
    const res = await fetch(filePath);
    if (!res.ok) throw new Error('Kh√¥ng th·ªÉ load page: ' + res.status);
    const htmlText = await res.text();
    const main = document.getElementById('main-content');
    main.innerHTML = htmlText;

    // Ch·∫°y t·∫•t c·∫£ script trong HTML
    const scripts = main.querySelectorAll('script');
    scripts.forEach(oldScript => {
      const newScript = document.createElement('script');
      if (oldScript.src) {
        newScript.src = oldScript.src;
        newScript.async = false;
      } else {
        newScript.textContent = oldScript.textContent;
      }
      document.body.appendChild(newScript);
      oldScript.remove();
    });

    // G·ªçi init function n·∫øu c√≥
    if (filePath.includes('member-list.html') && typeof initMemberList === 'function') {
      initMemberList();
    }

    if (filePath.includes('event-list.html') && typeof initEventList === 'function') {
      initEventList();
    }

    if (filePath.includes('attendance.html') && typeof initAttendance === 'function') {
      initAttendance();
    }
    if ( filePath.includes('send-notification.html') && typeof initSendNotification === 'function') {
      initSendNotification();
    }

  } catch(err) {
    alert(err.message);
  }
}


// ‚úÖ Logout
function logout() {
  localStorage.removeItem('token');
  window.location.href = '/login.html';
}

// üöÄ Khi m·ªü dashboard
verifyToken();
</script>
</body>
</html>
